<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>究极无敌牛逼超市比价</title>
</head>
<body>
<h1>究极无敌牛逼超市比价</h1>
<label for="kw" class="input_area">商品名称</label>
<input type="text" name="kw" id="kw" class="input_area">
<input type="submit" id="submit" onclick="request_form()" class="input_area">
<h2>比价结果</h2>
<table id="result">
    <tr>
        <th>名称</th>
        <th>图片</th>
        <th>价格</th>
        <th>来源</th>
        <th>单位价格</th>
    </tr>
</table>
</body>
</html>

<script>
    document.getElementById("kw").addEventListener("keypress", (event) => {
        if (event.key === 'Enter') {
            document.getElementById("submit").click()
        }
    })

    function gen_td(child) {
        let td = document.createElement("td")
        td.appendChild(child)
        return td
    }

    function render_form(j) {
        data = JSON.parse(j)
        let table = document.getElementById("result")

        table.innerHTML = "    <tr>\n" +
            "        <th>名称</th>\n" +
            "        <th>图片</th>\n" +
            "        <th>价格</th>\n" +
            "        <th>来源</th>\n" +
            "        <th>单位价格</th>\n" +
            "    </tr>"

        for (const item of data.items) {
            let row = document.createElement("tr")
            let name = document.createElement("a")
            name.setAttribute("href", item.url)
            let name_text = document.createTextNode(item.name)
            name.appendChild(name_text)
            let img = document.createElement("img")
            img.setAttribute("src", item.imgurl)
            let price = document.createTextNode(item.price)
            let store = document.createTextNode(item.store)
            let unitprice = document.createTextNode(item.unitprice)


            row.appendChild(gen_td(name))
            row.appendChild(gen_td(img))
            row.appendChild(gen_td(price))
            row.appendChild(gen_td(store))
            row.appendChild(gen_td(unitprice))
            table.appendChild(row)
        }
    }

    function request_form() {
        let request = new XMLHttpRequest()
        request.onreadystatechange = function () {
            if (request.readyState === 4) {
                document.getElementById("submit").removeAttribute("disabled")
                if (request.status === 200) {
                    return render_form(request.responseText)
                }
            }
        }
        let kw = document.getElementById("kw").value
        document.getElementById("submit").setAttribute("disabled", "")
        request.open("GET", "/query/" + kw)
        request.send()
    }
</script>

<style>
    img {
        max-height: 80px;
        max-width: 80px;
    }

    body {
        text-align: center;
    }

    table {
        margin: auto;
    }

    .input_area {
        height: 2rem;
    }
</style>